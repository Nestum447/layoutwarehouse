<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Racks Interactivos con Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .rack { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
    .totales { margin-top: 8px; font-weight: bold; }
    .nivel { margin: 5px 0; }
    .fila { margin: 5px 0; }
    .botones { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Dashboard de Racks</h1>
  <canvas id="dashboardChart" width="600" height="300"></canvas>
  <div id="racksContainer"></div>

  <script>
    /* =======================
      ConfiguraciÃ³n Firebase
    ======================= */
    const firebaseConfig = {
      apiKey: "AIzaSyDnqaBbnieclhdOdbbtaSaVuu7erU5_5_Y",
      authDomain: "layout-944b5.firebaseapp.com",
      projectId: "layout-944b5",
      storageBucket: "layout-944b5.firebasestorage.app",
      messagingSenderId: "153153107561",
      appId: "1:153153107561:web:2d44a5da67b7b6b9cdd4f8",
      measurementId: "G-LY17755TBD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* =======================
      Crear Racks dinÃ¡micamente
    ======================= */
    const racksContainer = document.getElementById("racksContainer");

    function crearRack(rackId, niveles, filas) {
      const rackDiv = document.createElement("div");
      rackDiv.className = "rack";
      rackDiv.id = rackId;

      rackDiv.innerHTML = `
        <h2>${rackId.toUpperCase()}</h2>
        <div class="botones">
          <button id="selectAll-${rackId}">Seleccionar TODOS</button>
          <button id="deselectAll-${rackId}">Deseleccionar TODOS</button>
        </div>
        <div class="totales" id="totales-${rackId}">
          âœ… Verdes: 0 | ðŸŸ§ Naranjas: 0 | âšª No seleccionados: 0
        </div>
      `;

      for (let n = 1; n <= niveles; n++) {
        const nivelDiv = document.createElement("div");
        nivelDiv.className = "nivel";
        nivelDiv.innerHTML = `<strong>Nivel ${n}</strong>`;
        for (let f = 1; f <= filas; f++) {
          const checkboxId = `${rackId}-N${n}F${f}`;
          nivelDiv.innerHTML += `
            <label>
              <input type="checkbox" id="${checkboxId}">
              Fila ${f}
            </label>
          `;
        }
        rackDiv.appendChild(nivelDiv);
      }

      racksContainer.appendChild(rackDiv);
    }

    // Crear 19 racks: 1â€“4 con 6 filas, los demÃ¡s con 4
    for (let i = 1; i <= 19; i++) {
      if (i <= 4) {
        crearRack(`rack${i}`, 1, 6);
      } else {
        crearRack(`rack${i}`, 1, 4);
      }
    }

    /* =======================
      Dashboard con Chart.js
    ======================= */
    const ctx = document.getElementById("dashboardChart").getContext("2d");
    const dashboardChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Verdes", "Naranjas", "No seleccionados"],
        datasets: [{
          label: "Totales",
          data: [0, 0, 0],
          backgroundColor: ["green", "orange", "lightgray"]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          datalabels: {
            anchor: "end",
            align: "end",
            color: "black",
            font: { weight: "bold" }
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      },
      plugins: [ChartDataLabels]
    });

    /* =======================
      ActualizaciÃ³n Totales
    ======================= */
    function actualizarTotales() {
      let totalVerdes = 0, totalNaranjas = 0, totalNoSel = 0;

      for (let i = 1; i <= 19; i++) {
        const rackId = `rack${i}`;
        const checkboxes = document.querySelectorAll(`#${rackId} input[type="checkbox"]`);

        let verdes = 0, naranjas = 0, noSel = 0;

        checkboxes.forEach(chk => {
          if (chk.checked && chk.dataset.color === "verde") verdes++;
          else if (chk.checked && chk.dataset.color === "naranja") naranjas++;
          else noSel++;
        });

        document.getElementById(`totales-${rackId}`).innerText =
          `âœ… Verdes: ${verdes} | ðŸŸ§ Naranjas: ${naranjas} | âšª No seleccionados: ${noSel}`;

        totalVerdes += verdes;
        totalNaranjas += naranjas;
        totalNoSel += noSel;
      }

      dashboardChart.data.datasets[0].data = [totalVerdes, totalNaranjas, totalNoSel];
      dashboardChart.update();
    }

    /* =======================
      Eventos Seleccionar/Deseleccionar
    ======================= */
    function setupRackButtons(rackId) {
      const selectAllBtn = document.getElementById(`selectAll-${rackId}`);
      const deselectAllBtn = document.getElementById(`deselectAll-${rackId}`);
      const checkboxes = document.querySelectorAll(`#${rackId} input[type="checkbox"]`);

      if (selectAllBtn) {
        selectAllBtn.addEventListener("click", () => {
          checkboxes.forEach(chk => {
            chk.checked = true;
            chk.dispatchEvent(new Event("change"));
          });
        });
      }

      if (deselectAllBtn) {
        deselectAllBtn.addEventListener("click", () => {
          checkboxes.forEach(chk => {
            chk.checked = false;
            chk.dispatchEvent(new Event("change"));
          });
        });
      }

      checkboxes.forEach(chk => {
        chk.addEventListener("change", () => {
          // Guardar en Firestore
          db.collection("racks").doc(chk.id).set({
            checked: chk.checked,
            color: chk.dataset.color || "ninguno"
          });
          actualizarTotales();
        });
      });
    }

    function initializeAllRacks() {
      for (let i = 1; i <= 19; i++) {
        setupRackButtons(`rack${i}`);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializeAllRacks();
      actualizarTotales();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</body>
</html>
