<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Racks Interactivos SL y SW</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-auth-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
#loginBox { background:#fff; border:1px solid #ccc; border-radius:10px; padding:20px; width:300px; margin:50px auto; text-align:center; }
#app { display:none; }
input { padding:8px; margin:5px 0; width:90%; border:1px solid #ccc; border-radius:5px; }
button { margin:5px; padding:8px 15px; border:none; border-radius:5px; background:#2196f3; color:white; cursor:pointer; }
button:hover { background:#1976d2; }
.rack { margin-bottom: 30px; padding: 10px; background: #fff; border: 2px solid #ccc; border-radius: 10px; }
.fila { display: flex; flex-wrap: nowrap; margin-bottom: 5px; align-items: center; }
.ubicacion { display: flex; margin-right: 3px; }
.sub { width: 30px; height: 30px; margin: 1px; background: #ddd; border-radius: 5px;
      text-align: center; line-height: 30px; font-size: 10px; cursor: pointer; user-select: none; }
.sub.seleccionada { background: #4caf50; color: white; }
.sub.piso { background: orange; color: white; }
#globalButtons { margin: 20px 0; text-align: center; }
#dashboard { position: sticky; top: 0; background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-around; align-items: center; gap:20px; }
.panel { width: 200px; }
.label { font-weight: bold; margin-bottom: 5px; text-align:center; }
.barContainer { background: #ccc; border-radius: 10px; height: 20px; width: 100%; overflow: hidden; display: flex; margin-top:5px;}
.bar { height: 100%; text-align: center; }
.verde { background:#4caf50; }
.naranja { background:orange; }
.gris { background:#999; }
.totalesRack { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="loginBox">
  <h2>üîê Iniciar Sesi√≥n</h2>
  <input type="email" id="email" placeholder="Correo" value="ncarpio935@gmail.com"><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button onclick="login()">Iniciar sesi√≥n</button>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</div>

<div id="app">
  <h1>üì¶ Simulaci√≥n de Bodega con Racks SL y SW + Firebase</h1>

  <div id="dashboard">
    <div class="panel">
      <div class="label">SL</div>
      <div class="barContainer">
        <div class="bar verde" id="barraVerdeSL"></div>
        <div class="bar naranja" id="barraNaranjaSL"></div>
        <div class="bar gris" id="barraNoSL"></div>
      </div>
      <div id="numSL" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
    </div>
    <div class="panel">
      <div class="label">SW</div>
      <div class="barContainer">
        <div class="bar verde" id="barraVerdeSW"></div>
        <div class="bar naranja" id="barraNaranjaSW"></div>
        <div class="bar gris" id="barraNoSW"></div>
      </div>
      <div id="numSW" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
    </div>
    <div class="panel">
      <div class="label">Total General</div>
      <div class="barContainer">
        <div class="bar verde" id="barraTotalVerde"></div>
        <div class="bar naranja" id="barraTotalNaranja"></div>
        <div class="bar gris" id="barraTotalNo"></div>
      </div>
      <div id="numTotal" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
    </div>
  </div>

  <div id="globalButtons">
    <button onclick="seleccionarTodos(true)">Seleccionar TODOS</button>
    <button onclick="seleccionarTodos(false)">Deseleccionar TODOS</button>
    <button onclick="guardarEstado()">üíæ Guardar Estados</button>
    <button onclick="descargarExcelHtml()">‚¨á Excel M√≥vil (HTML)</button>
    <button onclick="descargarExcelXLSX()">‚¨á Excel Escritorio (XLSX)</button>
  </div>

  <div id="contenedor"></div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDnqaBbnieclhdOdbbtaSaVuu7erU5_5_Y",
  authDomain: "layout-944b5.firebaseapp.com",
  projectId: "layout-944b5",
  storageBucket: "layout-944b5.firebasestorage.app",
  messagingSenderId: "153153107561",
  appId: "1:153153107561:web:2d44a5da67b7b6b9cdd4f8",
  measurementId: "G-LY17755TBD"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let estadoGlobal = {};
const docEstadoApp = "estado_SL_SW";
const letras = "ABCDEFGHIJKLMNOPQRSTUVW".split("");
const niveles = [1,2,3,4,5,6];
const racksSL = 15;
const racksSW = 19;
const contenedor = document.getElementById("contenedor");

// --- Login ---
function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email,password)
    .then(userCredential=>{
      const correo = userCredential.user.email;
      document.getElementById("loginBox").style.display="none";
      document.getElementById("app").style.display="block";
      if(correo==="ncarpio935@gmail.com") crearRacks(true);
      else {
        alert("Modo lectura");
        crearRacks(false);
      }
    }).catch(err=>{document.getElementById("loginError").innerText="‚ùå "+err.message;});
}

// --- Crear racks ---
async function crearRacks(permisoEscritura){
  try{ const docSnap=await db.collection("racks").doc(docEstadoApp).get(); if(docSnap.exists) estadoGlobal=docSnap.data(); } 
  catch(e){ console.error("Error al cargar estado:",e); }

  const todosRacks=[];
  for(let i=1;i<=racksSL;i++) todosRacks.push("RACK SL"+(i<10?"0"+i:i));
  for(let i=1;i<=racksSW;i++) todosRacks.push("RACK SW"+(i<10?"0"+i:i));

  todosRacks.forEach(rackName=>{
    const rack=document.createElement("div"); rack.className="rack";
    rack.innerHTML=`<h2>${rackName}</h2>`;

    if(permisoEscritura){
      const btnSel=document.createElement("button"); btnSel.innerText="Seleccionar Rack";
      btnSel.onclick=()=>seleccionarRack(rackName,true);
      const btnDes=document.createElement("button"); btnDes.innerText="Deseleccionar Rack";
      btnDes.onclick=()=>seleccionarRack(rackName,false);
      rack.appendChild(btnSel); rack.appendChild(btnDes);
    }

    niveles.forEach(nivel=>{
      const fila=document.createElement("div"); fila.className="fila";
      letras.forEach(letra=>{
        const ubicacion=document.createElement("div"); ubicacion.className="ubicacion";
        for(let i=1;i<=3;i++){
          const sub=document.createElement("div"); sub.className="sub";
          const idSub=`${rackName}_n${nivel}_l${letra}_i${i}`;
          sub.innerText=`${letra}${nivel}`;
          sub.dataset.rack=rackName; sub.dataset.nivel=nivel; sub.dataset.id=idSub; sub.dataset.estado=estadoGlobal[idSub]||"ninguno";
          if(sub.dataset.estado==="verde") sub.classList.add("seleccionada");
          else if(sub.dataset.estado==="piso") sub.classList.add("piso");

          if(permisoEscritura){
            sub.addEventListener("click",()=>{
              if(sub.classList.contains("seleccionada")){
                sub.classList.remove("seleccionada"); sub.dataset.estado="ninguno"; estadoGlobal[idSub]="ninguno";
              } else {
                sub.classList.add("seleccionada"); sub.classList.remove("piso"); sub.dataset.estado="verde"; estadoGlobal[idSub]="verde";
              }
              actualizarDashboard(); actualizarTotalesRack(rackName);
            });
          }
          ubicacion.appendChild(sub);
        }
        fila.appendChild(ubicacion);
      });
      rack.appendChild(fila);
    });

    const totalesRack=document.createElement("div"); totalesRack.className="totalesRack"; totalesRack.id=`totales-${rackName}`;
    rack.appendChild(totalesRack);
    contenedor.appendChild(rack);
    actualizarTotalesRack(rackName);
  });
  actualizarDashboard();
}

// --- Funciones de selecci√≥n ---
function seleccionarRack(rackName,seleccionar){
  document.querySelectorAll(`.sub[data-rack="${rackName}"]`).forEach(s=>{
    if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[s.dataset.id]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
  });
  actualizarDashboard(); actualizarTotalesRack(rackName);
}

function seleccionarTodos(seleccionar){
  document.querySelectorAll(".sub").forEach(s=>{
    if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[s.dataset.id]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
  });
  document.querySelectorAll(".rack").forEach(rack => actualizarTotalesRack(rack.querySelector("h2").innerText));
  actualizarDashboard();
}

// --- Totales ---
function actualizarTotalesRack(rackName){
  let verde=0,naranja=0,noSel=0;
  document.querySelectorAll(`.sub[data-rack="${rackName}"]`).forEach(s=>{
    if(s.dataset.estado==="verde") verde++;
    else if(s.dataset.estado==="piso") naranja++;
    else noSel++;
  });
  document.getElementById(`totales-${rackName}`).innerText=`Verde: ${verde} | Naranja: ${naranja} | No seleccionado: ${noSel}`;
}

// --- Dashboard ---
function actualizarDashboard(){
  let verdeSL=0,naranjaSL=0,noSL=0,verdeSW=0,naranjaSW=0,noSW=0;
  document.querySelectorAll(".sub").forEach(s=>{
    if(s.dataset.rack.startsWith("RACK SL")){
      if(s.dataset.estado==="verde") verdeSL++; else if(s.dataset.estado==="piso") naranjaSL++; else noSL++;
    } else if(s.dataset.rack.startsWith("RACK SW")){
      if(s.dataset.estado==="verde") verdeSW++; else if(s.dataset.estado==="piso") naranjaSW++; else noSW++;
    }
  });
  const totalSL=verdeSL+naranjaSL+noSL, totalSW=verdeSW+naranjaSW+noSW, total=totalSL+totalSW;
  document.getElementById("barraVerdeSL").style.width=(verdeSL/totalSL*100)+"%";
  document.getElementById("barraNaranjaSL").style.width=(naranjaSL/totalSL*100)+"%";
  document.getElementById("barraNoSL").style.width=(noSL/totalSL*100)+"%";
  document.getElementById("numSL").innerText=`V:${verdeSL} N:${naranjaSL} No:${noSL}`;
  document.getElementById("barraVerdeSW").style.width=(verdeSW/totalSW*100)+"%";
  document.getElementById("barraNaranjaSW").style.width=(naranjaSW/totalSW*100)+"%";
  document.getElementById("barraNoSW").style.width=(noSW/totalSW*100)+"%";
  document.getElementById("numSW").innerText=`V:${verdeSW} N:${naranjaSW} No:${noSW}`;
  document.getElementById("barraTotalVerde").style.width=((verdeSL+verdeSW)/total*100)+"%";
  document.getElementById("barraTotalNaranja").style.width=((naranjaSL+naranjaSW)/total*100)+"%";
  document.getElementById("barraTotalNo").style.width=((noSL+noSW)/total*100)+"%";
  document.getElementById("numTotal").innerText=`V:${verdeSL+verdeSW} N:${naranjaSL+naranjaSW} No:${noSL+noSW}`;
}

// --- Guardar en Firebase ---
async function guardarEstado(){
  try{ await db.collection("racks").doc(docEstadoApp).set(estadoGlobal); alert("Estados guardados"); }
  catch(e){ console.error(e); alert("Error al guardar"); }
}

// --- Descargar Excel M√≥vil (HTML) ---
function descargarExcelHtml(){
  let html='<table border="1" style="border-collapse: collapse;">';
  document.querySelectorAll(".rack").forEach(rack=>{
    html+=`<tr><th colspan="50">${rack.querySelector("h2").innerText}</th></tr>`;
    niveles.forEach(nivel=>{
      html+='<tr>';
      letras.forEach(letra=>{
        for(let i=1;i<=3;i++){
          const id=`${rack.querySelector("h2").innerText}_n${nivel}_l${letra}_i${i}`;
          const est=estadoGlobal[id]||"ninguno";
          let bg="#DDDDDD",color="#000";
          if(est==="verde"){ bg="#4CAF50"; color="#FFF"; }
          else if(est==="piso"){ bg="#FFA500"; color="#FFF"; }
          html+=`<td style="background:${bg};color:${color};text-align:center">${letra}${nivel}-${i}</td>`;
        }
      });
      html+='</tr>';
    });
    html+=`<tr><td colspan="50">${document.getElementById(`totales-${rack.querySelector("h2").innerText}`).innerText}</td></tr><tr></tr>`;
  });
  html+='</table>';
  const blob=new Blob([html],{type:"application/vnd.ms-excel"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="Bodega_Racks.xls"; a.click();
  URL.revokeObjectURL(a.href);
}

// --- Descargar Excel Escritorio (XLSX) ---
function descargarExcelXLSX(){
  const wb=XLSX.utils.book_new();
  const ws={}; let rowIndex=0;
  const borderStyle={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
  document.querySelectorAll(".rack").forEach(rack=>{
    const rackName=rack.querySelector("h2").innerText;
    XLSX.utils.sheet_add_aoa(ws,[[rackName]],{origin:{r:rowIndex,c:0}});
    rowIndex++;
    niveles.forEach(nivel=>{
      let colIndex=0;
      letras.forEach(letra=>{
        for(let i=1;i<=3;i++){
          const id=`${rackName}_n${nivel}_l${letra}_i${i}`;
          const val=estadoGlobal[id]||"ninguno";
          const cellRef=XLSX.utils.encode_cell({r:rowIndex,c:colIndex});
          ws[cellRef]={v:`${letra}${nivel}-${i}`,t:"s",s:{border:borderStyle}};
          if(val==="verde"){ ws[cellRef].s.fill={fgColor:{rgb:"4CAF50"}}; ws[cellRef].s.font={color:{rgb:"FFFFFF"},bold:true}; }
          else if(val==="piso"){ ws[cellRef].s.fill={fgColor:{rgb:"FFA500"}}; ws[cellRef].s.font={color:{rgb:"FFFFFF"},bold:true}; }
          else{ ws[cellRef].s.fill={fgColor:{rgb:"DDDDDD"}}; ws[cellRef].s.font={color:{rgb:"000000"}}; }
          colIndex++;
        }
      });
      rowIndex++;
    });
    const totales=document.getElementById(`totales-${rackName}`).innerText;
    ws[XLSX.utils.encode_cell({r:rowIndex,c:0})]={v:totales,t:"s",s:{border:borderStyle}};
    rowIndex+=2;
  });
  ws['!ref']=XLSX.utils.encode_range({s:{r:0,c:0},e:{r:rowIndex,c:100}});
  XLSX.utils.book_append_sheet(wb,ws,"Bodega Completa");
  XLSX.writeFile(wb,"Bodega_Racks.xlsx");
}
</script>
</body>
</html>
