<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Racks Interactivos con Excel + Firebase</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  // ConfiguraciÃ³n de Firebase (tus credenciales)
  const firebaseConfig = {
    apiKey: "AIzaSyDnqaBbnieclhdOdbbtaSaVuu7erU5_5_Y",
    authDomain: "layout-944b5.firebaseapp.com",
    projectId: "layout-944b5",
    storageBucket: "layout-944b5.firebasestorage.app",
    messagingSenderId: "153153107561",
    appId: "1:153153107561:web:2d44a5da67b7b6b9cdd4f8",
    measurementId: "G-LY17755TBD"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ----------------------- Variables globales -----------------------
  const letras = "ABCDEFGHIJKLMNOPQRSTUVW".split("");
  const niveles = [1,2,3,4,5,6];
  const totalRacks = 15;
  const contenedor = document.getElementById("contenedor");

  let estadoGlobal = {}; // objeto que guardarÃ¡ los estados de todas las sububicaciones

  // ----------------------- Funciones Firebase -----------------------
  async function guardarEstadoFirebase() {
    await setDoc(doc(db, "racks", "estado15"), estadoGlobal);
  }

  async function cargarEstadoFirebase() {
    const docRef = doc(db, "racks", "estado15");
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) estadoGlobal = docSnap.data();
  }

  // ----------------------- Funciones de totales -----------------------
  function actualizarTotales(rackNum){
    const subs = document.querySelectorAll(`.sub[data-rack="${rackNum}"]`);
    let verde=0, naranja=0;
    subs.forEach(s => { if(s.dataset.estado==="verde") verde++; if(s.dataset.estado==="piso") naranja++; });
    const combinadas = verde+naranja;
    const noSel = subs.length - combinadas;
    document.getElementById(`totales-${rackNum}`).innerText=
      `Rack ${rackNum} â†’ Verde: ${verde} | Naranja: ${naranja} | Combinadas: ${combinadas} | No seleccionadas: ${noSel}`;
  }

  function actualizarGranTotal(){
    const subs=document.querySelectorAll(".sub");
    let verde=0, naranja=0;
    subs.forEach(s => { if(s.dataset.estado==="verde") verde++; if(s.dataset.estado==="piso") naranja++; });
    const combinadas=verde+naranja;
    const noSel=subs.length-combinadas;
    document.getElementById("granTotal").innerText=
      `TOTAL â†’ Verde: ${verde} | Naranja: ${naranja} | Combinadas: ${combinadas} | No seleccionadas: ${noSel}`;
  }

  // ----------------------- Crear racks -----------------------
  async function inicializarRacks() {
    await cargarEstadoFirebase();

    for(let r=1; r<=totalRacks; r++){
      const rack = document.createElement("div"); rack.className="rack";
      rack.innerHTML=`<h2>Rack ${r}</h2>`;

      const btnSel = document.createElement("button"); btnSel.className="btn"; btnSel.innerText="Seleccionar Rack";
      btnSel.onclick = () => { seleccionarRack(r,true); guardarEstadoFirebase(); };
      const btnDes = document.createElement("button"); btnDes.className="btn"; btnDes.innerText="Deseleccionar Rack";
      btnDes.onclick = () => { seleccionarRack(r,false); guardarEstadoFirebase(); };
      rack.appendChild(btnSel); rack.appendChild(btnDes);

      niveles.forEach(nivel=>{
        const fila = document.createElement("div"); fila.className="fila";

        const filaBtnSel = document.createElement("button"); filaBtnSel.className="btn"; filaBtnSel.innerText=`Fila ${nivel} âœ”`;
        filaBtnSel.onclick = () => { seleccionarFila(r,nivel,true); guardarEstadoFirebase(); };
        const filaBtnDes = document.createElement("button"); filaBtnDes.className="btn"; filaBtnDes.innerText=`Fila ${nivel} âœ˜`;
        filaBtnDes.onclick = () => { seleccionarFila(r,nivel,false); guardarEstadoFirebase(); };
        const filaBtnPiso = document.createElement("button"); filaBtnPiso.className="btn"; filaBtnPiso.innerText=`UbicaciÃ³n Piso ${nivel}`;
        filaBtnPiso.onclick = () => { togglePiso(r,nivel); guardarEstadoFirebase(); };

        fila.appendChild(filaBtnSel); fila.appendChild(filaBtnDes); fila.appendChild(filaBtnPiso);

        letras.forEach(letra=>{
          const ubicacion = document.createElement("div"); ubicacion.className="ubicacion";
          for(let i=1;i<=3;i++){
            const sub = document.createElement("div"); sub.className="sub"; sub.innerText=`${letra}${nivel}`;
            sub.dataset.rack=r; sub.dataset.nivel=nivel; sub.dataset.estado="ninguno";
            
            // Aplicar estado desde Firebase si existe
            const key = `${r}-${nivel}-${letra}${nivel}-${i}`;
            if(estadoGlobal[key]){
              sub.dataset.estado = estadoGlobal[key];
              if(estadoGlobal[key]==="verde") sub.classList.add("seleccionada");
              if(estadoGlobal[key]==="piso") sub.classList.add("piso");
            }

            sub.addEventListener("click",()=>{
              if(sub.classList.contains("seleccionada")){
                sub.classList.remove("seleccionada"); sub.dataset.estado="ninguno";
              }else{
                sub.classList.add("seleccionada"); sub.classList.remove("piso"); sub.dataset.estado="verde";
              }
              estadoGlobal[key] = sub.dataset.estado;
              actualizarTotales(r); actualizarGranTotal();
              guardarEstadoFirebase();
            });

            ubicacion.appendChild(sub);
          }
          fila.appendChild(ubicacion);
        });

        rack.appendChild(fila);
      });

      const totales = document.createElement("div"); totales.className="totales"; totales.id=`totales-${r}`;
      rack.appendChild(totales);
      contenedor.appendChild(rack);
      actualizarTotales(r);
    }

    actualizarGranTotal();
  }

  // ----------------------- Funciones selecciÃ³n -----------------------
  function seleccionarRack(rackNum,seleccionar){
    const subs=document.querySelectorAll(`.sub[data-rack="${rackNum}"]`);
    subs.forEach(s=>{
      if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; }
      else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; }
      const key = `${s.dataset.rack}-${s.dataset.nivel}-${s.innerText}-${Array.from(subs).indexOf(s)+1}`;
      estadoGlobal[key] = s.dataset.estado;
    });
    actualizarTotales(rackNum); actualizarGranTotal();
  }

  function seleccionarFila(rackNum,nivel,seleccionar){
    const subs=document.querySelectorAll(`.sub[data-rack="${rackNum}"][data-nivel="${nivel}"]`);
    subs.forEach(s=>{
      if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; }
      else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; }
      const key = `${s.dataset.rack}-${s.dataset.nivel}-${s.innerText}-${Array.from(subs).indexOf(s)+1}`;
      estadoGlobal[key] = s.dataset.estado;
    });
    actualizarTotales(rackNum); actualizarGranTotal();
  }

  function togglePiso(rackNum,nivel){
    const subs=document.querySelectorAll(`.sub[data-rack="${rackNum}"][data-nivel="${nivel}"]`);
    subs.forEach(s=>{
      if(s.classList.contains("piso")){ s.classList.remove("piso"); s.dataset.estado="ninguno"; }
      else{ s.classList.add("piso"); s.classList.remove("seleccionada"); s.dataset.estado="piso"; }
      const key = `${s.dataset.rack}-${s.dataset.nivel}-${s.innerText}-${Array.from(subs).indexOf(s)+1}`;
      estadoGlobal[key] = s.dataset.estado;
    });
    actualizarTotales(rackNum); actualizarGranTotal();
  }

  function seleccionarTodos(seleccionar){
    for(let r=1;r<=totalRacks;r++) seleccionarRack(r,seleccionar);
    actualizarGranTotal();
    guardarEstadoFirebase();
  }

  // ----------------------- Inicializar -----------------------
  window.addEventListener("load", inicializarRacks);

</script>
</head>
<body>
<h1>ðŸ“¦ SimulaciÃ³n de Bodega con 15 Racks + Firebase</h1>
<div id="contenedor"></div>

<div id="globalButtons">
  <button class="btn" onclick="seleccionarTodos(true)">Seleccionar TODOS</button>
  <button class="btn" onclick="seleccionarTodos(false)">Deseleccionar TODOS</button>
  <button class="btn" onclick="descargarExcel()">â¬‡ Descargar Excel</button>
</div>

<div id="granTotal">TOTAL â†’ Verde: 0 | Naranja: 0 | Combinadas: 0 | No seleccionadas: 0</div>

<script>
  // FunciÃ³n de descarga Excel (igual que tu versiÃ³n anterior)
</script>
</body>
</html>
