<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Racks con Firebase</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js"></script>
<style>
body { font-family: Arial; background:#f5f5f5; margin:20px; }
.rack { padding:10px; margin-bottom:20px; background:#fff; border:2px solid #ccc; border-radius:10px;}
.fila { display:flex; flex-wrap:nowrap; margin-bottom:5px; align-items:center;}
.ubicacion { display:flex; margin-right:3px;}
.sub { width:30px;height:30px;margin:1px;background:#ddd;border-radius:5px;text-align:center;line-height:30px;font-size:10px;cursor:pointer;}
.sub.seleccionada { background:#4caf50; color:#fff;}
.sub.piso { background:orange; color:#fff;}
.totales { font-weight:bold; margin-top:10px;}
.btn { margin:5px; padding:5px 10px; background:#2196f3; color:#fff; border:none; border-radius:5px; cursor:pointer;}
.btn:hover { background:#1976d2;}
#granTotal { position:sticky; bottom:0; background:#222; color:#fff; padding:15px; border-radius:10px; font-size:18px; text-align:center;}
#globalButtons { margin:20px 0; text-align:center;}
</style>
</head>
<body>
<h1>ðŸ“¦ Bodega 15 Racks</h1>
<div id="contenedor"></div>
<div id="globalButtons">
  <button class="btn" onclick="seleccionarTodos(true)">Seleccionar TODOS</button>
  <button class="btn" onclick="seleccionarTodos(false)">Deseleccionar TODOS</button>
  <button class="btn" onclick="descargarExcel()">â¬‡ Descargar Excel</button>
</div>
<div id="granTotal">TOTAL â†’ Verde:0 | Naranja:0 | Combinadas:0 | No seleccionadas:0</div>

<script>
/* ====== Firebase ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDnqaBbnieclhdOdbbtaSaVuu7erU5_5_Y",
  authDomain: "layout-944b5.firebaseapp.com",
  projectId: "layout-944b5",
  storageBucket: "layout-944b5.appspot.com",
  messagingSenderId: "153153107561",
  appId: "1:153153107561:web:2d44a5da67b7b6b9cdd4f8",
  measurementId: "G-LY17755TBD"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ====== Variables ====== */
const letras = "ABCDEFGHIJKLMNOPQRSTUVW".split("");
const niveles = [1,2,3,4,5,6];
const totalRacks = 15;
const contenedor = document.getElementById("contenedor");
let estadoGlobal = {};

/* ====== Funciones Totales ====== */
function actualizarTotales(rackNum){
  const subs = document.querySelectorAll(`.sub[data-rack="${rackNum}"]`);
  let verde=0,naranja=0;
  subs.forEach(s=>{if(s.dataset.estado==="verde") verde++; if(s.dataset.estado==="piso") naranja++;});
  const combinadas = verde+naranja;
  const noSel=subs.length-combinadas;
  document.getElementById(`totales-${rackNum}`).innerText=
    `Rack ${rackNum} â†’ Verde:${verde} | Naranja:${naranja} | Combinadas:${combinadas} | No seleccionadas:${noSel}`;
}
function actualizarGranTotal(){
  const subs = document.querySelectorAll(".sub");
  let verde=0,naranja=0;
  subs.forEach(s=>{if(s.dataset.estado==="verde") verde++; if(s.dataset.estado==="piso") naranja++;});
  const combinadas=verde+naranja;
  const noSel=subs.length-combinadas;
  document.getElementById("granTotal").innerText=
    `TOTAL â†’ Verde:${verde} | Naranja:${naranja} | Combinadas:${combinadas} | No seleccionadas:${noSel}`;
}

/* ====== Crear Racks ====== */
async function crearRacks(){
  // Cargar estados desde Firestore
  const doc = await db.collection("racks").doc("estado15").get();
  if(doc.exists) estadoGlobal = doc.data();
  for(let r=1;r<=totalRacks;r++){
    const rack = document.createElement("div"); rack.className="rack";
    rack.innerHTML=`<h2>Rack ${r}</h2>`;
    const btnSel=document.createElement("button"); btnSel.className="btn"; btnSel.innerText="Seleccionar Rack";
    btnSel.onclick=()=>{ seleccionarRack(r,true); guardarFirebase(); };
    const btnDes=document.createElement("button"); btnDes.className="btn"; btnDes.innerText="Deseleccionar Rack";
    btnDes.onclick=()=>{ seleccionarRack(r,false); guardarFirebase(); };
    rack.appendChild(btnSel); rack.appendChild(btnDes);

    niveles.forEach(nivel=>{
      const fila=document.createElement("div"); fila.className="fila";
      letras.forEach(letra=>{
        const ubicacion=document.createElement("div"); ubicacion.className="ubicacion";
        for(let i=1;i<=3;i++){
          const sub=document.createElement("div"); sub.className="sub"; sub.innerText=`${letra}${nivel}`;
          sub.dataset.rack=r; sub.dataset.nivel=nivel;
          const key=`${r}-${nivel}-${letra}${nivel}-${i}`;
          const estado=estadoGlobal[key]||"ninguno";
          sub.dataset.estado=estado;
          if(estado==="verde") sub.classList.add("seleccionada");
          if(estado==="piso") sub.classList.add("piso");
          sub.addEventListener("click",()=>{
            if(sub.classList.contains("seleccionada")){
              sub.classList.remove("seleccionada"); sub.dataset.estado="ninguno"; estadoGlobal[key]="ninguno";
            } else { sub.classList.add("seleccionada"); sub.classList.remove("piso"); sub.dataset.estado="verde"; estadoGlobal[key]="verde"; }
            actualizarTotales(r); actualizarGranTotal(); guardarFirebase();
          });
          ubicacion.appendChild(sub);
        }
        fila.appendChild(ubicacion);
      });
      rack.appendChild(fila);
    });

    const totales=document.createElement("div"); totales.className="totales"; totales.id=`totales-${r}`;
    rack.appendChild(totales);
    contenedor.appendChild(rack);
    actualizarTotales(r);
  }
  actualizarGranTotal();
}

/* ====== Funciones SelecciÃ³n ====== */
function seleccionarRack(rackNum,sel){
  const subs=document.querySelectorAll(`.sub[data-rack="${rackNum}"]`);
  subs.forEach((s,i)=>{
    const key=`${rackNum}-${s.dataset.nivel}-${s.innerText}-${i+1}`;
    if(sel){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[key]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[key]="ninguno"; }
  });
  actualizarTotales(rackNum); actualizarGranTotal();
}
function seleccionarTodos(sel){ for(let r=1;r<=totalRacks;r++) seleccionarRack(r,sel); actualizarGranTotal(); guardarFirebase(); }

/* ====== Guardar en Firebase ====== */
function guardarFirebase(){ db.collection("racks").doc("estado15").set(estadoGlobal); }

/* ====== Excel ====== */
function descargarExcel(){ alert("FunciÃ³n Excel aquÃ­"); }

/* ====== Inicializar ====== */
crearRacks();
</script>
</body>
</html>
