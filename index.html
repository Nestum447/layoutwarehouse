<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Racks Interactivos SL y SW</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-auth-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h2 { margin-top: 30px; }
.rack { margin-bottom: 30px; padding: 10px; background: #fff; border: 2px solid #ccc; border-radius: 10px; }
.fila { display: flex; flex-wrap: nowrap; margin-bottom: 5px; align-items: center; }
.ubicacion { display: flex; margin-right: 3px; }
.sub { width: 30px; height: 30px; margin: 1px; background: #ddd; border-radius: 5px;
      text-align: center; line-height: 30px; font-size: 10px; cursor: pointer; user-select: none; }
.sub.seleccionada { background: #4caf50; color: white; }
.sub.piso { background: orange; color: white; }
.btn { margin: 5px 3px; padding: 5px 10px; background: #2196f3; color: #fff; border: none; border-radius: 5px; cursor:pointer; }
.btn:hover { background: #1976d2; }
#globalButtons { margin: 20px 0; text-align: center; }

#dashboard { position: sticky; top: 0; background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-around; align-items: center; gap:20px; }
.panel { width: 200px; }
.label { font-weight: bold; margin-bottom: 5px; text-align:center; }
.barContainer { background: #ccc; border-radius: 10px; height: 20px; width: 100%; overflow: hidden; display: flex; margin-top:5px;}
.bar { height: 100%; text-align: center; }
.verde { background:#4caf50; }
.naranja { background:orange; }
.gris { background:#999; }

.totalesRack { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<h1>üì¶ Simulaci√≥n de Bodega con Racks SL y SW + Firebase</h1>
<div id="userStatus" style="margin-bottom:10px; font-weight:bold;"></div>

<div id="dashboard">
  <div class="panel">
    <div class="label">SL</div>
    <div class="barContainer">
      <div class="bar verde" id="barraVerdeSL"></div>
      <div class="bar naranja" id="barraNaranjaSL"></div>
      <div class="bar gris" id="barraNoSL"></div>
    </div>
    <div id="numSL" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
  </div>
  <div class="panel">
    <div class="label">SW</div>
    <div class="barContainer">
      <div class="bar verde" id="barraVerdeSW"></div>
      <div class="bar naranja" id="barraNaranjaSW"></div>
      <div class="bar gris" id="barraNoSW"></div>
    </div>
    <div id="numSW" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
  </div>
  <div class="panel">
    <div class="label">Total General</div>
    <div class="barContainer">
      <div class="bar verde" id="barraTotalVerde"></div>
      <div class="bar naranja" id="barraTotalNaranja"></div>
      <div class="bar gris" id="barraTotalNo"></div>
    </div>
    <div id="numTotal" style="text-align:center; margin-top:2px;">V:0 N:0 No:0</div>
  </div>
</div>

<div id="globalButtons">
  <button class="btn" onclick="seleccionarTodos(true)">Seleccionar TODOS</button>
  <button class="btn" onclick="seleccionarTodos(false)">Deseleccionar TODOS</button>
  <button class="btn" onclick="guardarEstado()">üíæ Guardar Estados</button>
  <button class="btn" onclick="descargarExcel()">‚¨á Descargar Excel</button>
</div>

<div id="contenedor"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDnqaBbnieclhdOdbbtaSaVuu7erU5_5_Y",
  authDomain: "layout-944b5.firebaseapp.com",
  projectId: "layout-944b5",
  storageBucket: "layout-944b5.firebasestorage.app",
  messagingSenderId: "153153107561",
  appId: "1:153153107561:web:2d44a5da67b7b6b9cdd4f8",
  measurementId: "G-LY17755TBD"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const UID_PERMITIDO = "tifB8XR9ZLRsyTmyFJcFw6mwadG2"; // tu UID
let usuarioActual = null;

auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
  .then(result => {
    usuarioActual = result.user;
    if(usuarioActual.uid === UID_PERMITIDO){
      document.getElementById("userStatus").innerText = `‚úî Sesi√≥n iniciada como ${usuarioActual.email} (Puedes guardar datos)`;
    } else {
      document.getElementById("userStatus").innerText = `‚ùå Sesi√≥n iniciada como ${usuarioActual.email} (Solo lectura)`;
    }
  })
  .catch(error => {
    console.error("Error al iniciar sesi√≥n autom√°ticamente:", error);
    document.getElementById("userStatus").innerText = "‚ö† No se pudo iniciar sesi√≥n autom√°ticamente. Solo lectura.";
  });

const letras = "ABCDEFGHIJKLMNOPQRSTUVW".split("");
const niveles = [1,2,3,4,5,6];
const racksSL = 15;
const racksSW = 19;
const contenedor = document.getElementById("contenedor");
let estadoGlobal = {};  
const docEstadoApp = "estado_SL_SW";

// --- Guardar estados solo si UID coincide ---
async function guardarEstado(){
  if(!usuarioActual){
    alert("Debes iniciar sesi√≥n para guardar datos");
    return;
  }
  if(usuarioActual.uid !== UID_PERMITIDO){
    alert("No tienes permisos para modificar los datos");
    return;
  }
  try{
    await db.collection("racks").doc(docEstadoApp).set(estadoGlobal);
    alert("Estados guardados correctamente");
  }catch(e){
    console.error("Error al guardar estado:", e);
    alert("Error al guardar estado: " + e);
  }
}

// --- Funciones de creaci√≥n de racks ---
async function crearRacks(){
  try{
    const docSnap = await db.collection("racks").doc(docEstadoApp).get();
    if(docSnap.exists) estadoGlobal = docSnap.data();
  } catch(e){ console.error("Error al cargar estado:", e); }

  const todosRacks = [];
  for(let i=1;i<=racksSL;i++) todosRacks.push("RACK SL" + (i<10?"0"+i:i));
  for(let i=1;i<=racksSW;i++) todosRacks.push("RACK SW" + (i<10?"0"+i:i));

  todosRacks.forEach((rackName)=>{
    const rack = document.createElement("div"); rack.className="rack";
    rack.innerHTML=`<h2>${rackName}</h2>`;

    const btnSel = document.createElement("button"); btnSel.className="btn"; btnSel.innerText="Seleccionar Rack";
    btnSel.onclick = () => seleccionarRack(rackName,true);
    const btnDes = document.createElement("button"); btnDes.className="btn"; btnDes.innerText="Deseleccionar Rack";
    btnDes.onclick = () => seleccionarRack(rackName,false);
    rack.appendChild(btnSel); rack.appendChild(btnDes);

    niveles.forEach(nivel=>{
      const fila = document.createElement("div"); fila.className="fila";

      const filaBtnSel = document.createElement("button"); filaBtnSel.className="btn"; filaBtnSel.innerText=`Fila ${nivel} ‚úî`;
      filaBtnSel.onclick = () => seleccionarFila(rackName,nivel,true);
      const filaBtnDes = document.createElement("button"); filaBtnDes.className="btn"; filaBtnDes.innerText=`Fila ${nivel} ‚úò`;
      filaBtnDes.onclick = () => seleccionarFila(rackName,nivel,false);
      const filaBtnPiso = document.createElement("button"); filaBtnPiso.className="btn"; filaBtnPiso.innerText=`Ubicaci√≥n Piso ${nivel}`;
      filaBtnPiso.onclick = () => togglePiso(rackName,nivel);

      fila.appendChild(filaBtnSel); fila.appendChild(filaBtnDes); fila.appendChild(filaBtnPiso);

      letras.forEach(letra=>{
        const ubicacion = document.createElement("div"); ubicacion.className="ubicacion";
        for(let i=1;i<=3;i++){
          const sub = document.createElement("div"); sub.className="sub"; 
          sub.innerText=`${letra}${nivel}`;
          const idSub = `${rackName}_n${nivel}_l${letra}_i${i}`;
          sub.dataset.rack=rackName; sub.dataset.nivel=nivel; sub.dataset.id=idSub; sub.dataset.estado="ninguno";
          if(estadoGlobal[idSub]==="verde") { sub.classList.add("seleccionada"); sub.dataset.estado="verde"; }
          if(estadoGlobal[idSub]==="piso") { sub.classList.add("piso"); sub.dataset.estado="piso"; }

          sub.addEventListener("click", ()=>{
            if(sub.classList.contains("seleccionada")){
              sub.classList.remove("seleccionada"); sub.dataset.estado="ninguno"; estadoGlobal[idSub]="ninguno";
            }else{
              sub.classList.add("seleccionada"); sub.classList.remove("piso"); sub.dataset.estado="verde"; estadoGlobal[idSub]="verde";
            }
            actualizarDashboard(); actualizarTotalesRack(rackName);
          });
          ubicacion.appendChild(sub);
        }
        fila.appendChild(ubicacion);
      });
      rack.appendChild(fila);
    });

    const totalesRack = document.createElement("div"); totalesRack.className="totalesRack"; totalesRack.id=`totales-${rackName}`;
    rack.appendChild(totalesRack);
    contenedor.appendChild(rack);
    actualizarTotalesRack(rackName);
  });
  actualizarDashboard();
}

// --- Funciones de selecci√≥n ---
function seleccionarRack(rackName, seleccionar){
  document.querySelectorAll(`.sub[data-rack="${rackName}"]`).forEach(s=>{
    if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[s.dataset.id]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
  });
  actualizarDashboard(); actualizarTotalesRack(rackName);
}

function seleccionarFila(rackName,nivel,seleccionar){
  document.querySelectorAll(`.sub[data-rack="${rackName}"][data-nivel="${nivel}"]`).forEach(s=>{
    if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[s.dataset.id]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
  });
  actualizarDashboard(); actualizarTotalesRack(rackName);
}

function togglePiso(rackName,nivel){
  document.querySelectorAll(`.sub[data-rack="${rackName}"][data-nivel="${nivel}"]`).forEach(s=>{
    if(s.classList.contains("piso")){ s.classList.remove("piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
    else{ s.classList.add("piso"); s.classList.remove("seleccionada"); s.dataset.estado="piso"; estadoGlobal[s.dataset.id]="piso"; }
  });
  actualizarDashboard(); actualizarTotalesRack(rackName);
}

function seleccionarTodos(seleccionar){
  document.querySelectorAll(".sub").forEach(s=>{
    if(seleccionar){ s.classList.add("seleccionada"); s.classList.remove("piso"); s.dataset.estado="verde"; estadoGlobal[s.dataset.id]="verde"; }
    else{ s.classList.remove("seleccionada","piso"); s.dataset.estado="ninguno"; estadoGlobal[s.dataset.id]="ninguno"; }
  });
  document.querySelectorAll(".rack").forEach(rack => actualizarTotalesRack(rack.querySelector("h2").innerText));
  actualizarDashboard();
}

// --- Totales por rack ---
function actualizarTotalesRack(rackName){
  let verde=0, naranja=0, noSel=0;
  document.querySelectorAll(`.sub[data-rack="${rackName}"]`).forEach(s=>{
    if(s.dataset.estado==="verde") verde++;
    else if(s.dataset.estado==="piso") naranja++;
    else noSel++;
  });
  document.getElementById(`totales-${rackName}`).innerText = `Verde: ${verde} | Naranja: ${naranja} | No seleccionado: ${noSel}`;
}

// --- Dashboard ---
function actualizarDashboard(){
  let verdeSL=0, naranjaSL=0, noSL=0;
  let verdeSW=0, naranjaSW=0, noSW=0;

  document.querySelectorAll(".sub").forEach(s=>{
    if(s.dataset.rack.startsWith("RACK SL")){
      if(s.dataset.estado==="verde") verdeSL++;
      else if(s.dataset.estado==="piso") naranjaSL++;
      else noSL++;
    } else if(s.dataset.rack.startsWith("RACK SW")){
      if(s.dataset.estado==="verde") verdeSW++;
      else if(s.dataset.estado==="piso") naranjaSW++;
      else noSW++;
    }
  });

  const totalSL = verdeSL+naranjaSL+noSL;
  const totalSW = verdeSW+naranjaSW+noSW;
  const total = totalSL+totalSW;

  document.getElementById("barraVerdeSL").style.width = (verdeSL/totalSL*100)+"%";
  document.getElementById("barraNaranjaSL").style.width = (naranjaSL/totalSL*100)+"%";
  document.getElementById("barraNoSL").style.width = (noSL/totalSL*100)+"%";
  document.getElementById("numSL").innerText = `V:${verdeSL} N:${naranjaSL} No:${noSL}`;

  document.getElementById("barraVerdeSW").style.width = (verdeSW/totalSW*100)+"%";
  document.getElementById("barraNaranjaSW").style.width = (naranjaSW/totalSW*100)+"%";
  document.getElementById("barraNoSW").style.width = (noSW/totalSW*100)+"%";
  document.getElementById("numSW").innerText = `V:${verdeSW} N:${naranjaSW} No:${noSW}`;

  document.getElementById("barraTotalVerde").style.width = ((verdeSL+verdeSW)/total*100)+"%";
  document.getElementById("barraTotalNaranja").style.width = ((naranjaSL+naranjaSW)/total*100)+"%";
  document.getElementById("barraTotalNo").style.width = ((noSL+noSW)/total*100)+"%";
  document.getElementById("numTotal").innerText = `V:${verdeSL+verdeSW} N:${naranjaSL+naranjaSW} No:${noSL+noSW}`;
}

// --- Descargar Excel ---
function descargarExcel(){
  const wb = XLSX.utils.book_new();
  const ws_data = [];
  document.querySelectorAll(".rack").forEach(rack=>{
    const rackName = rack.querySelector("h2").innerText;
    ws_data.push([rackName]);
    niveles.forEach(nivel=>{
      const row=[];
      letras.forEach(letra=>{
        for(let i=1;i<=3;i++){
          const idSub = `${rackName}_n${nivel}_l${letra}_i${i}`;
          const val = estadoGlobal[idSub];
          if(val==="verde") row.push("V");
          else if(val==="piso") row.push("P");
          else row.push("");
        }
      });
      ws_data.push(row);
    });
    const totales = document.getElementById(`totales-${rackName}`).innerText;
    ws_data.push([totales]);
    ws_data.push([]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Bodega Completa");
  XLSX.writeFile(wb,"Bodega_Racks.xlsx");
}

crearRacks();
</script>
</body>
</html>
